# onionion: Write-up

Это задание — вложенная стеганография: после решения получается ещё одно задание на стеганографию, потом ещё и ещё. Название отсылает к многослойному луку, который в семь шуб одет, а кто его по слоям раздевает — тот слёзы проливает. Содержание этапов — отсылка к сказке про смерть Кощееву, которая заключена в игле, игло — в яйце, яйцо — в утке, утка — в зайце, заяц — в сундуке, сундук — под дубом, а дуб — на острове на море на океане. Разгадав эту отсылку, можно понимать, сколько ещё шагов осталось до флага.

Исходники промежуточных этапов и скрипт, выполняющий стеганографию, можно посмотреть в [develop/](develop/).

**Остров.** Картинка с островом — не просто картинка, на что намекает её размер. На самом деле это [rarjpeg](https://lurkmo.re/rarjpeg) (точнее, zipjpeg) — картинка с приклеенным архивом. Достаточно изменить расширение файла на .zip и разархивировать. Обнаружить и извлечь архив также можно было с помощью binwalk.

**Дуб.** Документ со статьёй армянской Википедии про дуб, как и любые документы в форматах docx, xlsx и pptx, является zip-архивом. Разархивировав его, находим файл `word/activeX/activeX4.xml` размера намного большего, чем все остальные файлы вместе взятые. Он содержит очень большой текстовый комментарий.

**Сундук.** Длинный повторяющийся много раз текст из русской Википедии про сундук содержит в словах латинские буквы. Можно заметить, что все имеющиеся в тексте латинские буквы (A, B, E, K, M, H, O, P, C, T, X, a, e, o, p, c, y, x) выглядят точно так же, как соответствующие им русские. Исключив из текста все остальные символы и приняв русские буквы за 1, а нерусские за 0, получаем двоичную запись, из которой нужно создать файл.

**Заяц.** Звуковую дорожку аудио про зайца — цитаты из «Ну, погоди» — можно прочитать библиотекой pysoundfile. Получится массив чисел, которые кодируют звук — интенсивность в зависимости от времени. Последние биты этих чисел (иначе говоря, остатки от деления на 2) образуют двоичный код очередного файла.

**Утка.** Изображение резиновой уточки можно было просмотреть с помощью stegsolve — или просто выкрутить контраст и заметить странный шум. Информация содержится в двух последних битах каждого канала каждого пиксела. Выписав по шесть бит с каждого пиксела (два из красного канала, два из зелёного и два из синего), можно получить двоичный код, а по коду создать файл.

**Яйцо.** Картинка яйца, у которой нужно прочитать EXIF, а именно, поле Exif.Photo.MakerNote (его также можно увидеть с помощью strings). Оно содержит длинный шестнадцатеричный код — из соответствующих байт нужно сделать файл.

**Игла.** На картинке по-японски написано «игла» (а в скобках — «уцуцуга»). На картинке лишь два цвета, чёрный и белый, но в stegsolve можно увидеть, что часть чёрной области образована разными цветами палитры. Номера цветов в этой области надо проинтерпретировать как символы ASCII, отбросив непечатные символы с кодами менее 32 — останется флаг.

Вот и **смерть Кощеева.**

Флаг: **ugra\_will\_you\_make\_the\_villain\_die\_after\_all**
